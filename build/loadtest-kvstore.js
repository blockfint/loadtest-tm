"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _ws_client = _interopRequireDefault(require("./ws_client"));

var tendermintWsPool = _interopRequireWildcard(require("./ws_pool"));

const fetch = require('node-fetch');

const uuidv4 = require('uuid/v4');

const accurateInterval = require('accurate-interval');

const uuidv1 = require('uuid/v1');

const jobs = {};
const IP = '52.163.191.111';
const PORT = '26000';
var messageCounter = 0;
let duration = process.env.DURATION || 1;
let txpersec = process.env.TXPERSEC || 1;
let max_connection = 0;
let connection = 0;
let keyV1 = uuidv1();
let valueV4 = uuidv4();
let keyRunningNumber = 0;
let valueRunningNumber = 0;

function startJob(duration, interval, requestsPerInterval) {
  let jobId = uuidv4();
  jobs[jobId] = {
    startedAt: null,
    stoppedAt: null,
    finishedAt: null,
    intervalFunc: null,
    intervalCount: 0
  };
  const numberOfIntervals = Math.floor(duration / interval);
  jobs[jobId].startedAt = Date.now();
  jobs[jobId].intervalFunc = accurateInterval(() => {
    jobs[jobId].intervalCount++;

    if (jobs[jobId].intervalCount > numberOfIntervals) {
      stopJob(jobId);
      return;
    }

    for (let j = 0; j < requestsPerInterval; j++) {
      createRequestToPlatform();
    }
  }, interval * 1000);
  console.log(`Job started: ${jobId}`); //sendJobUpdateToClients(jobId);
}

function stopJob(jobId) {
  if (jobs[jobId] == null) throw new Error(`Unknown Job ID: ${jobId}`);
  if (jobs[jobId].intervalFunc == null) throw new Error(`Job is already stopped: ${jobId}`);
  jobs[jobId].intervalFunc.clear();
  jobs[jobId].intervalFunc = null;
  jobs[jobId].stoppedAt = Date.now();
  console.log('Total tx send: ', messageCounter);
}

async function createRequestToPlatform() {
  try {
    // let key = `${keyV1}${keyRunningNumber++}`;
    // let value = `${valueV4}${valueRunningNumber++}`;
    // connection++;
    // await fetch(`http://${IP}:${PORT}/broadcast_tx_sync?tx="${key}=${value}"`);
    // if (connection > max_connection) {
    //   max_connection = connection;
    //   console.log('Max connection : ', max_connection);
    // }
    // connection--;
    // messageCounter++;
    let key = `${keyV1}${keyRunningNumber++}`;
    let value = `${valueV4}${valueRunningNumber++}`;
    let param = `${key}=${value}`;
    let buffer = Buffer.from(param, 'utf8');
    await tendermintWsPool.getConnection().broadcastTxSync(buffer);
    messageCounter++;
  } catch (error) {
    console.error(error);
  }
}

async function connectWS(duration, txpersec) {
  await tendermintWsPool.initialize();
  startJob(duration, 1, txpersec);
}

async function test() {
  let key = `${keyV1}${keyRunningNumber++}`;
  let value = `${valueV4}${valueRunningNumber++}`;
  let param = `${key}=${value}`;
  let a = Buffer.from(param, 'utf8');
  await tendermintWsPool.getConnection().broadcastTxSync(a);
}

connectWS(duration, txpersec);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9sb2FkdGVzdC1rdnN0b3JlLmpzIl0sIm5hbWVzIjpbImZldGNoIiwicmVxdWlyZSIsInV1aWR2NCIsImFjY3VyYXRlSW50ZXJ2YWwiLCJ1dWlkdjEiLCJqb2JzIiwiSVAiLCJQT1JUIiwibWVzc2FnZUNvdW50ZXIiLCJkdXJhdGlvbiIsInByb2Nlc3MiLCJlbnYiLCJEVVJBVElPTiIsInR4cGVyc2VjIiwiVFhQRVJTRUMiLCJtYXhfY29ubmVjdGlvbiIsImNvbm5lY3Rpb24iLCJrZXlWMSIsInZhbHVlVjQiLCJrZXlSdW5uaW5nTnVtYmVyIiwidmFsdWVSdW5uaW5nTnVtYmVyIiwic3RhcnRKb2IiLCJpbnRlcnZhbCIsInJlcXVlc3RzUGVySW50ZXJ2YWwiLCJqb2JJZCIsInN0YXJ0ZWRBdCIsInN0b3BwZWRBdCIsImZpbmlzaGVkQXQiLCJpbnRlcnZhbEZ1bmMiLCJpbnRlcnZhbENvdW50IiwibnVtYmVyT2ZJbnRlcnZhbHMiLCJNYXRoIiwiZmxvb3IiLCJEYXRlIiwibm93Iiwic3RvcEpvYiIsImoiLCJjcmVhdGVSZXF1ZXN0VG9QbGF0Zm9ybSIsImNvbnNvbGUiLCJsb2ciLCJFcnJvciIsImNsZWFyIiwia2V5IiwidmFsdWUiLCJwYXJhbSIsImJ1ZmZlciIsIkJ1ZmZlciIsImZyb20iLCJ0ZW5kZXJtaW50V3NQb29sIiwiZ2V0Q29ubmVjdGlvbiIsImJyb2FkY2FzdFR4U3luYyIsImVycm9yIiwiY29ubmVjdFdTIiwiaW5pdGlhbGl6ZSIsInRlc3QiLCJhIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFLQTs7QUFDQTs7QUFOQSxNQUFNQSxLQUFLLEdBQUdDLE9BQU8sQ0FBQyxZQUFELENBQXJCOztBQUNBLE1BQU1DLE1BQU0sR0FBR0QsT0FBTyxDQUFDLFNBQUQsQ0FBdEI7O0FBQ0EsTUFBTUUsZ0JBQWdCLEdBQUdGLE9BQU8sQ0FBQyxtQkFBRCxDQUFoQzs7QUFDQSxNQUFNRyxNQUFNLEdBQUdILE9BQU8sQ0FBQyxTQUFELENBQXRCOztBQUtB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akQsQ0FBTjtBQUNEOztBQUVESCxTQUFTLENBQUMzQyxRQUFELEVBQVdJLFFBQVgsQ0FBVCIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGZldGNoID0gcmVxdWlyZSgnbm9kZS1mZXRjaCcpO1xuY29uc3QgdXVpZHY0ID0gcmVxdWlyZSgndXVpZC92NCcpO1xuY29uc3QgYWNjdXJhdGVJbnRlcnZhbCA9IHJlcXVpcmUoJ2FjY3VyYXRlLWludGVydmFsJyk7XG5jb25zdCB1dWlkdjEgPSByZXF1aXJlKCd1dWlkL3YxJyk7XG5cbmltcG9ydCBUZW5kZXJtaW50V3NDbGllbnQgZnJvbSAnLi93c19jbGllbnQnO1xuaW1wb3J0ICogYXMgdGVuZGVybWludFdzUG9vbCBmcm9tICcuL3dzX3Bvb2wnO1xuXG5jb25zdCBqb2JzID0ge307XG5cbmNvbnN0IElQID0gJzUyLjE2My4xOTEuMTExJztcbmNvbnN0IFBPUlQgPSAnMjYwMDAnO1xuXG52YXIgbWVzc2FnZUNvdW50ZXIgPSAwO1xubGV0IGR1cmF0aW9uID0gcHJvY2Vzcy5lbnYuRFVSQVRJT04gfHwgMTtcbmxldCB0eHBlcnNlYyA9IHByb2Nlc3MuZW52LlRYUEVSU0VDIHx8IDE7XG5sZXQgbWF4X2Nvbm5lY3Rpb24gPSAwO1xubGV0IGNvbm5lY3Rpb24gPSAwO1xuXG5sZXQga2V5VjEgPSB1dWlkdjEoKTtcbmxldCB2YWx1ZVY0ID0gdXVpZHY0KCk7XG5sZXQga2V5UnVubmluZ051bWJlciA9IDA7XG5sZXQgdmFsdWVSdW5uaW5nTnVtYmVyID0gMDtcblxuZnVuY3Rpb24gc3RhcnRKb2IoZHVyYXRpb24sIGludGVydmFsLCByZXF1ZXN0c1BlckludGVydmFsKSB7XG4gIGxldCBqb2JJZCA9IHV1aWR2NCgpO1xuICBqb2JzW2pvYklkXSA9IHtcbiAgICBzdGFydGVkQXQ6IG51bGwsXG4gICAgc3RvcHBlZEF0OiBudWxsLFxuICAgIGZpbmlzaGVkQXQ6IG51bGwsXG4gICAgaW50ZXJ2YWxGdW5jOiBudWxsLFxuICAgIGludGVydmFsQ291bnQ6IDAsXG4gIH07XG5cbiAgY29uc3QgbnVtYmVyT2ZJbnRlcnZhbHMgPSBNYXRoLmZsb29yKGR1cmF0aW9uIC8gaW50ZXJ2YWwpO1xuXG4gIGpvYnNbam9iSWRdLnN0YXJ0ZWRBdCA9IERhdGUubm93KCk7XG5cbiAgam9ic1tqb2JJZF0uaW50ZXJ2YWxGdW5jID0gYWNjdXJhdGVJbnRlcnZhbCgoKSA9PiB7XG4gICAgam9ic1tqb2JJZF0uaW50ZXJ2YWxDb3VudCsrO1xuXG4gICAgaWYgKGpvYnNbam9iSWRdLmludGVydmFsQ291bnQgPiBudW1iZXJPZkludGVydmFscykge1xuICAgICAgc3RvcEpvYihqb2JJZCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgZm9yIChsZXQgaiA9IDA7IGogPCByZXF1ZXN0c1BlckludGVydmFsOyBqKyspIHtcbiAgICAgIGNyZWF0ZVJlcXVlc3RUb1BsYXRmb3JtKCk7XG4gICAgfVxuICB9LCBpbnRlcnZhbCAqIDEwMDApO1xuXG4gIGNvbnNvbGUubG9nKGBKb2Igc3RhcnRlZDogJHtqb2JJZH1gKTtcblxuICAvL3NlbmRKb2JVcGRhdGVUb0NsaWVudHMoam9iSWQpO1xufVxuXG5mdW5jdGlvbiBzdG9wSm9iKGpvYklkKSB7XG4gIGlmIChqb2JzW2pvYklkXSA9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gSm9iIElEOiAke2pvYklkfWApO1xuICBpZiAoam9ic1tqb2JJZF0uaW50ZXJ2YWxGdW5jID09IG51bGwpXG4gICAgdGhyb3cgbmV3IEVycm9yKGBKb2IgaXMgYWxyZWFkeSBzdG9wcGVkOiAke2pvYklkfWApO1xuICBqb2JzW2pvYklkXS5pbnRlcnZhbEZ1bmMuY2xlYXIoKTtcbiAgam9ic1tqb2JJZF0uaW50ZXJ2YWxGdW5jID0gbnVsbDtcbiAgam9ic1tqb2JJZF0uc3RvcHBlZEF0ID0gRGF0ZS5ub3coKTtcbiAgY29uc29sZS5sb2coJ1RvdGFsIHR4IHNlbmQ6ICcsIG1lc3NhZ2VDb3VudGVyKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlUmVxdWVzdFRvUGxhdGZvcm0oKSB7XG4gIHRyeSB7XG4gICAgLy8gbGV0IGtleSA9IGAke2tleVYxfSR7a2V5UnVubmluZ051bWJlcisrfWA7XG4gICAgLy8gbGV0IHZhbHVlID0gYCR7dmFsdWVWNH0ke3ZhbHVlUnVubmluZ051bWJlcisrfWA7XG4gICAgLy8gY29ubmVjdGlvbisrO1xuICAgIC8vIGF3YWl0IGZldGNoKGBodHRwOi8vJHtJUH06JHtQT1JUfS9icm9hZGNhc3RfdHhfc3luYz90eD1cIiR7a2V5fT0ke3ZhbHVlfVwiYCk7XG4gICAgLy8gaWYgKGNvbm5lY3Rpb24gPiBtYXhfY29ubmVjdGlvbikge1xuICAgIC8vICAgbWF4X2Nvbm5lY3Rpb24gPSBjb25uZWN0aW9uO1xuICAgIC8vICAgY29uc29sZS5sb2coJ01heCBjb25uZWN0aW9uIDogJywgbWF4X2Nvbm5lY3Rpb24pO1xuICAgIC8vIH1cbiAgICAvLyBjb25uZWN0aW9uLS07XG4gICAgLy8gbWVzc2FnZUNvdW50ZXIrKztcbiAgICBsZXQga2V5ID0gYCR7a2V5VjF9JHtrZXlSdW5uaW5nTnVtYmVyKyt9YDtcbiAgICBsZXQgdmFsdWUgPSBgJHt2YWx1ZVY0fSR7dmFsdWVSdW5uaW5nTnVtYmVyKyt9YDtcbiAgICBsZXQgcGFyYW0gPSBgJHtrZXl9PSR7dmFsdWV9YDtcbiAgICBsZXQgYnVmZmVyID0gQnVmZmVyLmZyb20ocGFyYW0sICd1dGY4Jyk7XG4gICAgYXdhaXQgdGVuZGVybWludFdzUG9vbC5nZXRDb25uZWN0aW9uKCkuYnJvYWRjYXN0VHhTeW5jKGJ1ZmZlcik7XG4gICAgbWVzc2FnZUNvdW50ZXIrKztcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBjb25uZWN0V1MoZHVyYXRpb24sIHR4cGVyc2VjKSB7XG4gIGF3YWl0IHRlbmRlcm1pbnRXc1Bvb2wuaW5pdGlhbGl6ZSgpO1xuICBzdGFydEpvYihkdXJhdGlvbiwgMSwgdHhwZXJzZWMpO1xufVxuXG5hc3luYyBmdW5jdGlvbiB0ZXN0KCkge1xuICBsZXQga2V5ID0gYCR7a2V5VjF9JHtrZXlSdW5uaW5nTnVtYmVyKyt9YDtcbiAgbGV0IHZhbHVlID0gYCR7dmFsdWVWNH0ke3ZhbHVlUnVubmluZ051bWJlcisrfWA7XG4gIGxldCBwYXJhbSA9IGAke2tleX09JHt2YWx1ZX1gO1xuICBsZXQgYSA9IEJ1ZmZlci5mcm9tKHBhcmFtLCAndXRmOCcpO1xuICBhd2FpdCB0ZW5kZXJtaW50V3NQb29sLmdldENvbm5lY3Rpb24oKS5icm9hZGNhc3RUeFN5bmMoYSk7XG59XG5cbmNvbm5lY3RXUyhkdXJhdGlvbiwgdHhwZXJzZWMpO1xuIl19